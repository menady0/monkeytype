// const words = `Lorem ipsum dolor sit amet consectetur adipisicing elit. Fugiat voluptatibus possimus debitis repudiandae voluptates earum, adipisci consequuntur libero nostrum. Asperiores debitis est commodi eveniet expedita. Ipsum debitis culpa provident voluptatibus sunt necessitatibus ab voluptate molestiae deleniti iure, nisi repellendus qui consequuntur! Illum amet commodi, debitis, autem quidem minus corporis deserunt nulla nihil consequatur ipsam quam libero at velit consectetur repellat? Aperiam iusto sed ab quae beatae voluptate tempore optio consequuntur? Distinctio saepe placeat dolor ratione impedit dignissimos? Repellendus corporis enim minima, illum eveniet nisi officia vero autem, ipsum vel voluptatum saepe sequi officiis sit delectus, consequuntur blanditiis. Repellendus eveniet aperiam necessitatibus. Laudantium alias quam culpa, quae et accusantium quis adipisci nihil, totam quibusdam voluptates voluptatem ex cupiditate iusto inventore velit distinctio incidunt laborum temporibus atque! Laudantium iure ex itaque molestias consectetur impedit inventore. Quia dignissimos modi animi similique, eum incidunt possimus deserunt exercitationem laboriosam? Numquam dolor velit quibusdam, deleniti adipisci alias, quisquam laudantium sunt unde pariatur in autem aperiam voluptatibus eos sapiente eius ab nihil aspernatur natus non. Iusto asperiores autem omnis earum in voluptatum nam. Nisi quam beatae tenetur eaque unde dolore, sed quos reiciendis nemo reprehenderit ipsum aliquid ad officiis labore architecto. Impedit reiciendis consequuntur consectetur veritatis accusantium nihil eaque rerum ad dolorum fuga obcaecati adipisci quaerat, commodi, facilis amet excepturi, cupiditate doloremque ducimus veniam hic expedita laudantium similique libero quidem? Expedita a, voluptates placeat ut iste velit voluptatibus debitis eum accusantium earum ipsam necessitatibus dolorum saepe libero labore corrupti, dolor repudiandae facilis, molestias nesciunt? Inventore distinctio atque dolorem doloremque cupiditate pariatur esse obcaecati laborum labore at hic voluptas tempora nihil, sunt deserunt vel eum quasi itaque aliquam accusantium suscipit! Sapiente molestias veritatis doloribus eaque? Possimus velit adipisci ratione sint, earum quos repellendus accusantium nisi enim distinctio doloribus, molestias eligendi sit nulla. Modi odio molestiae, dolor dolorem esse architecto repellendus consequuntur! Distinctio ullam quo ratione magni incidunt? Suscipit, in. Explicabo voluptatum aliquid commodi excepturi, inventore accusamus quibusdam. Consequatur odit eius assumenda illum a accusantium tenetur dolores ab debitis quis. Eum officiis, quis praesentium voluptatem debitis sequi cupiditate, veniam, consequatur maxime quidem ratione eaque repudiandae doloremque temporibus. Ullam sed mollitia sit vel inventore ea facere labore, nisi et aspernatur autem incidunt excepturi officiis reprehenderit quos totam quam. Magnam, totam vero earum dolor, necessitatibus voluptatibus nulla dolore maxime est ab, quibusdam dignissimos iusto. Itaque ducimus optio unde doloremque, qui tenetur. Eaque fugit quasi assumenda obcaecati. Voluptatem laboriosam harum dolor accusamus, ea minima cum dolorem officia, doloribus quae quidem ullam, tempora ut ad fugit nam nesciunt voluptas. Perferendis optio veritatis reiciendis nesciunt temporibus explicabo sapiente consequuntur iusto officia ab quod exercitationem facilis voluptas eveniet porro quis maiores adipisci mollitia, possimus, atque laboriosam amet! Sint earum cum ut debitis libero ullam aperiam impedit eaque iusto eum illo sed doloribus nisi accusamus soluta culpa quibusdam, asperiores, veniam aliquid. Doloremque laboriosam ut voluptatem possimus sed vero dolorem amet reiciendis rem suscipit cupiditate, non, minima rerum! Ratione soluta velit cupiditate repellendus! Quod quas expedita quaerat commodi illum reiciendis dignissimos consequuntur sequi natus beatae, praesentium hic ad velit, exercitationem qui incidunt ex. Reprehenderit autem similique officiis inventore distinctio esse vitae alias voluptatibus dolorum numquam. Odit maiores laudantium sed mollitia nemo, ducimus ipsam autem commodi molestias unde, aliquid dicta accusamus. Animi sint facere laboriosam qui repudiandae explicabo aliquam maxime dicta ea, reprehenderit pariatur tenetur veritatis ex! Sint sapiente illo, labore veritatis reiciendis velit mollitia aspernatur non dolorem. Distinctio vel esse consequatur, laudantium iste cum, assumenda officia soluta voluptates, officiis doloremque aspernatur? Laudantium, dolorum! Quae, perferendis harum recusandae dolor iusto ratione corporis quo, eligendi autem rerum error deserunt tenetur velit, totam tempore eius molestiae alias quaerat ea perspiciatis deleniti vero magni mollitia! Fugit, deleniti atque. Soluta, ipsum, eos, veniam voluptas delectus eaque dolor assumenda doloremque quam fugit voluptatum voluptates debitis expedita enim quibusdam tempora quia esse et porro. Neque quo, tempora assumenda voluptas cupiditate, est dolor fugiat provident nisi, libero sed quidem quas magnam porro excepturi illum accusantium eligendi! Sapiente incidunt ullam culpa voluptatum accusamus, vel omnis non assumenda quidem vero, commodi laborum velit, ex facilis tempora distinctio earum iusto officia doloremque officiis tenetur. Explicabo sapiente natus qui est, debitis nam delectus eveniet error at recusandae voluptatibus sed doloribus ipsa consequuntur adipisci officia vitae? Doloremque veniam consectetur cum, eveniet nulla deleniti repellat molestiae optio beatae. Id deleniti molestias, esse cumque, fugiat a ipsa magni hic commodi aliquam, expedita sit accusantium impedit. Sunt laboriosam dicta ipsum veritatis est modi nobis pariatur deserunt officia, nulla tempore suscipit inventore optio quam nam dolor quod sint perspiciatis tenetur eum at esse libero repudiandae eligendi? Nam modi reprehenderit, animi magnam a exercitationem saepe cupiditate quam! Pariatur autem odit cupiditate nisi, qui atque nulla, officiis ipsa excepturi unde nihil exercitationem dolore non repudiandae maxime et rem blanditiis mollitia beatae corporis vitae. Quo amet esse facilis velit molestias eos veniam, natus enim quos asperiores! Corporis, inventore. Consequuntur quas perspiciatis laborum debitis atque pariatur cum porro eius amet beatae quo veritatis dicta mollitia non alias maxime, numquam impedit! Ducimus saepe neque, tempore, sint reiciendis, id ut voluptatibus quam nisi explicabo quia voluptate nam accusamus modi at? Optio repellat expedita laboriosam, incidunt molestiae sunt, vel velit veniam sint ea quae facilis maxime obcaecati quibusdam id repellendus laudantium quam ad doloremque illo illum reprehenderit aperiam enim fugiat! Suscipit maiores doloremque quaerat provident enim praesentium laborum minima odio ab iusto quibusdam veritatis, quia alias aut quis. Accusamus soluta modi rem dignissimos velit ipsum! Voluptatem necessitatibus dolores eligendi, aspernatur corporis voluptas officiis expedita aliquam consequatur consequuntur ab fugiat beatae iure repellat cum quasi corrupti, veniam animi sequi commodi sapiente enim at voluptatum! Suscipit quidem odio ex, voluptate veniam iste repellat adipisci reiciendis saepe libero itaque non, minus, totam necessitatibus quas repudiandae? Necessitatibus dignissimos quam sunt eveniet neque ratione maiores aliquam quas suscipit, facilis impedit aliquid sint eaque nesciunt alias, repellat hic earum. Nemo nihil placeat hic quod, qui consequuntur sunt velit quo porro veniam laudantium quia? Quia nobis qui, at reprehenderit fugit iure vitae minus, hic eligendi nam molestias, natus magnam maxime quo repellat neque. Laborum odio quam quae modi.`.split(' ')
const words = `apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat ink jar key lion mouse nest owl pig quail rose snake tiger umbrella vase whale x-ray yak zebra apple banana cat dog elephant fish grape house ice jump kite lemon moon night orange pear queen rabbit sun tree umbrella violin water xylophone yellow zebra ant bear car door egg frog goat hat`.split(' ')
const wordsCount = words.length;
const gameTimer = 30
window.timer = null;
window.gameStart = null;

function newGame() {
  const wordsElement = document.querySelector('#words');
  wordsElement.innerHTML = ''
  // 200 is the number of words that will be shown
  for (let i = 0; i < 400; i++) {
    wordsElement.innerHTML += formatWord(randomWord());
  }
  removeClass(document.querySelector('#game'), 'over')

  addClass(document.querySelector('.word'), clName = 'current')
  addClass(document.querySelector('.letter'), clName = 'current')
  document.querySelector('.timer').innerHTML = gameTimer.toString();
  window.timer = null;
}


function formatWord(word){
  return `
  <div class='word'><span class="letter">${word.split('').join('</span><span class = "letter">')}</span></div>
  `
}
function randomWord(){
  const randomIndex = Math.ceil(Math.random() * wordsCount);
  return words[randomIndex - 1]
}
function addClass(element, clName){
  element.className += ' ' + clName;
}
function removeClass(element, clName){
  element.className = element.className.replace(clName, '')
}

function gameOver(){
  clearInterval(window.timer)
  addClass(document.querySelector('#game'), 'over')
  
  document.querySelector('.timer').innerHTML = `WPM: ${getWPM().toString()}`
}

function getWPM() {
  const words = [...document.querySelectorAll('.word')]
  const lastTypedWord = document.querySelector('.word.current')
  const lastTypedWordIndex = words.indexOf(lastTypedWord)
  const typedWords = [...words.slice(0, lastTypedWordIndex)]
  const correctWords = typedWords.filter(word => {
    const letters = [...word.children]
    let wrong = 0
    let correct = 0
    letters.forEach(letter => {
      if(letter.classList.contains('wrong'))
        wrong++
      if(letter.classList.contains('correct'))
        correct++
    })
    return wrong === 0 && correct === letters.length
  })
  return correctWords.length / gameTimer * 60;
}

document.querySelector('#game').addEventListener('keyup', ev => {
  const key = ev.key
  const currentWord = document.querySelector('.word.current')
  const currentLetter = document.querySelector('.letter.current')
  const expected = currentLetter?.innerHTML || ' '
  // const isLetter = key.length == 1 && key != ' '
  const isLetter = key.length == 1 && key !== ' '
  const isSpace = key === ' '
  const isBackspace = key === 'Backspace'
  const isFirstLetter = currentLetter === currentWord.firstChild


  if(document.querySelector('#game.over')){
    return;
  }


  if(!window.timer && isLetter){
    document.querySelector('.row').style.opacity = '0'
    document.querySelector('.timer').style.opacity = '1'

    window.timer = setInterval(() => {
      if(!window.gameStart){
        window.gameStart = (new Date()).getTime();
      }
      const currentTime = (new Date()).getTime();
      const msPassed = currentTime - window.gameStart
      const sPassed = Math.round(msPassed / 1000)
      const sLeft = gameTimer - sPassed;
      if(sLeft <= 0){
        gameOver();
        return;
      }
      document.querySelector('.timer').innerHTML = sLeft + ' ';
    }, 1000);
  }

  if(isLetter){
    if(currentLetter){
      const clName = key === expected ? "correct" : "wrong"
      addClass(currentLetter, clName)
      removeClass(currentLetter, 'current')
      if(currentLetter.nextElementSibling){
        addClass(currentLetter.nextElementSibling, 'current')
      } 
    }
    else {
      const incorrectLetters = document.createElement('span')
      incorrectLetters.innerHTML += key
      incorrectLetters.className = 'letter wrong extra'
      currentWord.appendChild(incorrectLetters)
    }
  }
  if (isSpace) {
    if(expected !== ' '){
      const letters = document.querySelectorAll('.word.current .letter:not(.correct)')
      letters.forEach(letter => {
        addClass(letter, 'wrong')
      })
    }
    removeClass(currentWord, 'current')
    addClass(currentWord.nextElementSibling, 'current')
    if(currentLetter){
      removeClass(currentLetter, 'current')
    }
    addClass(currentWord.nextElementSibling.firstChild, 'current')
  }
  if(isBackspace){
    // First Letter in the second word
    if(currentLetter && isFirstLetter){
      removeClass(currentWord, 'current')
      addClass(currentWord.previousElementSibling, 'current')

      removeClass(currentLetter, 'current')
      addClass(currentWord.previousElementSibling.lastChild, 'current')

      removeClass(currentWord.previousElementSibling.lastChild, 'wrong')
      removeClass(currentWord.previousElementSibling.lastChild, 'correct')
    }
    // Letter in the middle of the word
    if(currentLetter && !isFirstLetter){
      removeClass(currentLetter, 'current')
      addClass(currentLetter.previousElementSibling, 'current')

      removeClass(currentLetter.previousElementSibling, 'wrong')
      removeClass(currentLetter.previousElementSibling, 'correct')
    }
    // Last letter in the word
    if(!currentLetter){
      addClass(currentWord.lastChild, 'current')

      removeClass(currentWord.lastChild, 'wrong')
      removeClass(currentWord.lastChild, 'correct')
    }
    // Extra letter in the word
    // if(currentLetter.classList.contains('extra')){
    //   const incorrectLetters = document.querySelector('.extra')
    //   incorrectLetters.remove();
    // }
  }

  // Scrolling the words  
  if(currentWord.getBoundingClientRect().top > 250){
    const words = document.querySelector('#words')
    const margin = parseInt(words.style.marginTop || '0px')
    words.style.marginTop = (margin - 35) + 'px';
  }

  // Moving Cursor
  const nextLetter = document.querySelector('.letter.current')
  const nextWord = document.querySelector('.word.current')
  const cursor = document.querySelector('#cursor')
  
  if(nextLetter){
    cursor.style.top = nextLetter.getBoundingClientRect().top + 2 + "px"
    cursor.style.left = nextLetter.getBoundingClientRect().left + "px"
  }
  else {
    cursor.style.top = nextWord.getBoundingClientRect().top + "px"
    cursor.style.left = nextWord.getBoundingClientRect().right + "px"
  }
})


document.querySelector('#newGamebtn').addEventListener('click', () => {
  location.reload();
  // gameOver();
  // newGame();
})


document.querySelector('#showSettings').addEventListener('click', () => {
  document.querySelector('.row').classList.toggle('show')
})

newGame();